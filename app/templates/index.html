<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Supply Chain Blockchain Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f9fafb; }
    .navbar { background: linear-gradient(90deg, #0d6efd, #6610f2); }
    .navbar-brand { color: white !important; font-weight: 600; }
    .card { border-radius: 1rem; box-shadow: 0 0 15px rgba(0,0,0,0.08); }
    .badge { font-size: 0.9rem; }
    footer { text-align:center; margin-top:2rem; color:#777; }
  </style>
</head>
<body class="pb-5">

  <!-- üîπ Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">Blockchain Supply Chain</a>
      <div class="d-flex">
        <a href="{{ url_for('add') }}" class="btn btn-light me-2">‚ûï Add Product</a>
        <a href="{{ url_for('scan_all') }}" class="btn btn-warning me-2">üîç Integrity Check</a>
        <a href="{{ url_for('export_csv') }}" class="btn btn-success">üìÅ Export CSV</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <!-- üîπ Products Table -->
      <div class="col-lg-8">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Registered Products</h3>
            <input id="searchInput" class="form-control w-50" placeholder="üîç Search products...">
          </div>

          <div class="table-responsive">
            <table class="table align-middle table-striped">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Date Added</th>
                  <th>Status</th>
                  <th>QR</th>
                  <th>Anomalies</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {# expect product_rows to be (product, status, anomalies) #}
                {% for p, status, anomalies in product_rows %}
                <tr>
                  <td>{{ p.product_id }}</td>
                  <td>{{ p.name }}</td>
                  <td>{{ p.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    {% if status == 'OK' %}
                      <span class="badge bg-success">Verified</span>
                    {% elif status == 'FAILED' %}
                      <span class="badge bg-danger">Tampered</span>
                    {% elif status == 'ANOMALY' %}
                      <span class="badge bg-warning text-dark">Anomaly</span>
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if p.qr_path %}
                      <img src="{{ url_for('static', filename=p.qr_path) }}" width="70" alt="QR">
                    {% endif %}
                  </td>
                  <td>
                    {% if anomalies %}
                      <small class="text-muted">{{ anomalies|length }} issue{{ 's' if anomalies|length > 1 }}</small>
                    {% else %}
                      <small class="text-success">None</small>
                    {% endif %}
                  </td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('product_detail', product_id=p.product_id) }}">View</a>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="7" class="text-center text-muted">No products added yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- üîπ Right column: Stats Card + Chart -->
      <div class="col-lg-4">
        <div class="card p-4 mb-4">
          <h4 class="text-center">Blockchain Statistics</h4>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between"><strong>Verified</strong><span class="text-success">{{ stat_ok|default(0) }}</span></li>
            <li class="list-group-item d-flex justify-content-between"><strong>Tampered</strong><span class="text-danger">{{ stat_failed|default(0) }}</span></li>
            <li class="list-group-item d-flex justify-content-between"><strong>Anomalies</strong><span class="text-warning">{{ stat_anomaly|default(0) }}</span></li>
          </ul>
        </div>

        <div class="card p-4">
          <h5 class="text-center mb-3">Integrity Overview</h5>
          <canvas id="statusChart" width="300" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- üîπ Footer -->
  <footer>
    <p class="mt-4">¬© 2025 Blockchain Supply Chain | Built with Flask + Web3.py + SQLite</p>
  </footer>

  <!-- üîπ Scripts -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Search bar filter (guard if element missing)
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('keyup', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('tbody tr').forEach(tr => {
          tr.style.display = tr.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
      });
    }

    // Chart.js pie chart (guard if canvas exists)
    const chartEl = document.getElementById('statusChart');
    if (chartEl) {
      const ctx = chartEl.getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Verified', 'Tampered', 'Anomaly'],
          datasets: [{
            data: [
              {{ stat_ok|default(0) }},
              {{ stat_failed|default(0) }},
              {{ stat_anomaly|default(0) }}
            ],
            backgroundColor: ['#198754', '#dc3545', '#ffc107'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          }
        }
      });
    }
  });
  </script>

</body>
</html>
